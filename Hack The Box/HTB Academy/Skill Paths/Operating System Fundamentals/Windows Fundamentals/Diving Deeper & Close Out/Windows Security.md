### Introduction
- **Windows Security Overview:**
    - Windows systems have a vast attack surface due to numerous built-in features, applications, and complex settings. Misconfigurations can lead to vulnerabilities, even on fully patched systems.
    - Over the years, Windows has suffered from many critical vulnerabilities, enabling remote and local exploits.
- **Security Improvements and Features:**
    - Microsoft has continually improved security in Windows as attackers become more sophisticated.
    - New features have been added to help administrators **harden** systems, **block** intrusions, and **detect** misuse attempts.
- **Security Principles in Windows:**
    - Windows follows principles where **users**, **computers**, **threads**, or **processes** can be **authorized** or **authenticated** for specific actions.
    - These principles are designed to make it harder for attackers to gain unauthorized access or exploit the system.



### Security Identifier (SID)
- **Security Identifiers (SIDs):**
    - Each security principal in Windows has a unique **Security Identifier (SID)**, which is automatically generated by the system.
    - Even if two users are identical, Windows can distinguish them based on their SIDs, which are stored in the security database.
    - SIDs are added to the user's **access token** to track and control their authorized actions.
- **SID Structure:**
    - A SID is made up of two main components:
        - **Identifier Authority**
        - **Relative ID (RID)**
    - In an **Active Directory (AD)** domain environment, the SID also includes the **domain SID**.
```powershell-session
PS C:\htb> whoami /user

USER INFORMATION
----------------

User Name           SID
=================== =============================================
ws01\bob S-1-5-21-674899381-4069889467-2080702030-1002
```
- The SID is broken down into this pattern.
```powershell-session
(SID)-(revision level)-(identifier-authority)-(subauthority1)-(subauthority2)-(etc)
```
- Let's break down the SID piece by piece.
![[Screenshot_20241109_110115.png]]



### Security Accounts Manager (SAM) and Access Control Entries (ACE)
- **SAM (Security Account Manager):**
    - SAM grants rights to a network to execute specific processes.
- **Access Control Entries (ACE) and Access Control Lists (ACL):**
    - Access rights are managed by **ACE** in **ACLs**, which define which users, groups, or processes have access to files or the ability to execute processes.
- **Security Descriptors and ACL Types:**
    - Permissions to access securable objects are defined by **security descriptors**, which include two types of ACLs:
        - **Discretionary Access Control List (DACL)**
        - **System Access Control List (SACL)**
- **Authorization Process:**
    - Every thread and process initiated by a user goes through an **authorization process**.
    - **Access tokens** validated by the **Local Security Authority (LSA)** are integral to this process, containing the **SID** and other security-relevant information.
- **Privilege Escalation:**
    - Understanding these mechanisms is essential for learning how to work around security controls during the **privilege escalation** phase.



### User Account Control (UAC)
- **User Account Control (UAC):**
    - UAC is a security feature in Windows that prevents malware from running or manipulating processes that could damage the computer or its contents.
    - **Admin Approval Mode** is designed to prevent unauthorized software installations and system-wide changes without the administrator's knowledge.
- **Consent Prompt:**
    - When installation requires administrator rights, a consent prompt appears asking for confirmation to install software or make changes.
    - For a standard user, execution is either denied or a password prompt for the administrator appears.
- **UAC and Malware:**
    - The consent prompt interrupts the execution of scripts or binaries that malware or attackers may try to run, requiring user intervention to continue.
- **Understanding UAC's Structure:**
    - To fully understand how UAC works, it's important to know what triggers the consent prompt and how it is structured.
    - A diagram, adapted from the Microsoft documentation, illustrates how UAC functions.
![[uacarchitecture1_png.png]]



### Registry
- The [Registry](https://en.wikipedia.org/wiki/Windows_Registry) is a hierarchical database in Windows critical for the operating system.
- It stores low-level settings for the Windows operating system and applications that choose to use it. It is divided into computer-specific and user-specific data. 
- We can open the Registry Editor by typing `regedit` from the command line or Windows search bar.
![[regedit_png.png]]
- The tree-structure consists of main folders (root keys) in which subfolders (subkeys) with their entries/files (values) are located. 
- There are 11 different types of values that can be entered in a subkey.
![[Screenshot_20241109_110452.png]]
- Source: [https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-value-types](https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-value-types)
- Each folder under `Computer` is a key. 
- The root keys all start with `HKEY`.
- A key such as `HKEY-LOCAL-MACHINE` is abbreviated to `HKLM`. HKLM contains all settings that are relevant to the local system. 
- This root key contains six subkeys like `SAM`, `SECURITY`, `SYSTEM`, `SOFTWARE`, `HARDWARE`, and `BCD`, loaded into memory at boot time (except `HARDWARE` which is dynamically loaded).
![[regedit2_png.png]]
- The entire system registry is stored in several files on the operating system. 
- You can find these under `C:\Windows\System32\Config\`.
```powershell-session
PS C:\htb> ls

    Directory: C:\Windows\system32\config

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         12/7/2019   4:14 AM                Journal
d-----         12/7/2019   4:14 AM                RegBack
d-----         12/7/2019   4:14 AM                systemprofile
d-----         8/12/2020   1:43 AM                TxR
-a----         8/13/2020   6:02 PM        1048576 BBI
-a----         6/25/2020   4:36 PM          28672 BCD-Template
-a----         8/30/2020  12:17 PM       33816576 COMPONENTS
-a----         8/13/2020   6:02 PM         524288 DEFAULT
-a----         8/26/2020   7:51 PM        4603904 DRIVERS
-a----         6/25/2020   3:37 PM          32768 ELAM
-a----         8/13/2020   6:02 PM          65536 SAM
-a----         8/13/2020   6:02 PM          65536 SECURITY
-a----         8/13/2020   6:02 PM       87818240 SOFTWARE
-a----         8/13/2020   6:02 PM       17039360 SYSTEM
```
- The user-specific registry hive (HKCU) is stored in the user folder (i.e., `C:\Users\<USERNAME>\Ntuser.dat`).
```powershell-session
PS C:\htb> gci -Hidden

    Directory: C:\Users\bob

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d--h--         6/25/2020   5:12 PM                AppData
d--hsl         6/25/2020   5:12 PM                Application Data
d--hsl         6/25/2020   5:12 PM                Cookies
d--hsl         6/25/2020   5:12 PM                Local Settings
d--h--         6/25/2020   5:12 PM                MicrosoftEdgeBackups
d--hsl         6/25/2020   5:12 PM                My Documents
d--hsl         6/25/2020   5:12 PM                NetHood
d--hsl         6/25/2020   5:12 PM                PrintHood
d--hsl         6/25/2020   5:12 PM                Recent
d--hsl         6/25/2020   5:12 PM                SendTo
d--hsl         6/25/2020   5:12 PM                Start Menu
d--hsl         6/25/2020   5:12 PM                Templates
-a-h--         8/13/2020   6:01 PM        2883584 NTUSER.DAT
-a-hs-         6/25/2020   5:12 PM         524288 ntuser.dat.LOG1
-a-hs-         6/25/2020   5:12 PM        1011712 ntuser.dat.LOG2
-a-hs-         8/17/2020   5:46 PM        1048576 NTUSER.DAT{53b39e87-18c4-11ea-a811-000d3aa4692b}.TxR.0.regtrans-ms
-a-hs-         8/17/2020  12:13 PM        1048576 NTUSER.DAT{53b39e87-18c4-11ea-a811-000d3aa4692b}.TxR.1.regtrans-ms
-a-hs-         8/17/2020  12:13 PM        1048576 NTUSER.DAT{53b39e87-18c4-11ea-a811-000d3aa4692b}.TxR.2.regtrans-ms
-a-hs-         8/17/2020   5:46 PM          65536 NTUSER.DAT{53b39e87-18c4-11ea-a811-000d3aa4692b}.TxR.blf
-a-hs-         6/25/2020   5:15 PM          65536 NTUSER.DAT{53b39e88-18c4-11ea-a811-000d3aa4692b}.TM.blf
-a-hs-         6/25/2020   5:12 PM         524288 NTUSER.DAT{53b39e88-18c4-11ea-a811-000d3aa4692b}.TMContainer000000000
                                                  00000000001.regtrans-ms
-a-hs-         6/25/2020   5:12 PM         524288 NTUSER.DAT{53b39e88-18c4-11ea-a811-000d3aa4692b}.TMContainer000000000
                                                  00000000002.regtrans-ms
---hs-         6/25/2020   5:12 PM             20 ntuser.ini
```



### Run and RunOnce Registry Keys
- There are also so-called registry hives, which contain a logical group of keys, subkeys, and values to support software and files loaded into memory when the operating system is started or a user logs in. 
- These hives are useful for maintaining access to the system. 
- These are called [Run and RunOnce registry keys](https://docs.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys).
- The Windows registry includes the following four keys.
```powershell-session
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
```
- Here is an example of the `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run` key while logged in to a system.
```powershell-session
PS C:\htb> reg query HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run

HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
    SecurityHealth    REG_EXPAND_SZ    %windir%\system32\SecurityHealthSystray.exe
    RTHDVCPL    REG_SZ    "C:\Program Files\Realtek\Audio\HDA\RtkNGUI64.exe" -s
    Greenshot    REG_SZ    C:\Program Files\Greenshot\Greenshot.exe
```
- Here is an example of the `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run` showing applications running under the current user while logged in to a system.
```powershell-session
PS C:\htb> reg query HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
    OneDrive    REG_SZ    "C:\Users\bob\AppData\Local\Microsoft\OneDrive\OneDrive.exe" /background
    OPENVPN-GUI    REG_SZ    C:\Program Files\OpenVPN\bin\openvpn-gui.exe
    Docker Desktop    REG_SZ    C:\Program Files\Docker\Docker\Docker Desktop.exe
```



### Application Whitelisting
- **Application Whitelist:**    
    - A whitelist contains a list of approved software or executables that are allowed to run on a system. It aims to protect the environment from malware and unapproved software that doesn't meet business needs.
    - Implementing an enforced whitelist can be challenging, especially in large networks. Itâ€™s recommended to start with audit mode to ensure necessary applications are not mistakenly blocked.
- **Blacklisting vs. Whitelisting:**
    - **Blacklisting** blocks specific harmful or disallowed software, allowing all others to run.
    - **Whitelisting** follows a "zero trust" principle, where all software is considered bad unless explicitly allowed. Whitelisting usually requires less ongoing maintenance than blacklisting, as administrators only need to specify what's allowed, not constantly update a list of new malicious software.
- **Recommendation:**
    - Whitelisting is recommended by organizations like [NIST](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-167.pdf), particularly in high-security environments.



### AppLocker
- **AppLocker Overview:**
    - AppLocker is Microsoft's application whitelisting solution, introduced in Windows 7. It provides system administrators control over which applications and files users can execute.
    - AppLocker allows granular control over executables, scripts, Windows installer files, DLLs, packaged apps, and app installers.
- **Customization and Rules:**
    - Administrators can create rules based on file attributes like the publisher's name (from the digital signature), product name, file name, and version. Rules can also be set based on file paths and hashes.
    - Rules can be applied to security groups or individual users, tailored to the business needs.
- **Deployment and Testing:**
    - AppLocker can be deployed in audit mode initially to test the impact before enforcing rules, ensuring minimal disruption to operations.



### Local Group Policy
- Group Policy allows administrators to set, configure, and adjust a variety of settings.
- In a domain environment, group policies are pushed down from a Domain Controller onto all domain-joined machines that Group Policy objects (GPOs) are linked to. 
- These settings can also be defined on individual machines using Local Group Policy.
- Group Policy can be configured locally, in both domain environments and non-domain environments. 
- Local Group Policy can be used to tweak certain graphical and network settings that are otherwise not accessible via the Control Panel. 
- It can also be used to lock down an individual computer policy with stringent security settings, such as only allowing certain programs to be installed/run or enforcing strict user account password requirements.
- We can open the Local Group Policy Editor by opening the Start menu and typing `gpedit.msc`. 
- The editor is split into two categories under Local Computer Policy - `Computer Configuration` and `User Configuration`.
![[Local_GP_png.png]]
- For example, we can open the Local Computer Policy to enable Credential Guard by enabling the setting `Turn On Virtualization Based Security`. 
- Credential Guard is a feature in Windows 10 that protects against credential theft attacks by isolating the operating system's LSA process.
![[credguard_png.png]]
- We can also enable fine-tuned account auditing and configure AppLocker from the Local Group Policy Editor. 
- It is worth exploring Local Group Policy and learning about the wide variety of ways it can be used to lock down a Windows system.



### Windows Defender Antivirus
- Windows Defender Antivirus (Defender), formerly known as Windows Defender, is built-in antivirus that ships for free with Windows operating systems. 
- It was first released as a downloadable anti-spyware tool for Windows XP and Server 2003. Defender started coming prepackaged as part of the operating system with Windows Vista/Server 2008. 
- The program was renamed to Windows Defender Antivirus with the Windows 10 Creators Update.
- Defender comes with several features such as real-time protection, which protects the device from known threats in real-time and cloud-delivered protection, which works in conjunction with automatic sample submission to upload suspicious files for analysis. 
- When files are submitted to the cloud protection service, they are "locked" to prevent any potentially malicious behavior until the analysis is complete. 
- Another feature is Tamper Protection, which prevents security settings from being changed through the Registry, PowerShell cmdlets, or group policy.
- Windows Defender is managed from the Security Center, from which a variety of additional security features and settings can be enabled and managed.
![[Defender_sec_center_png.png]]
- Real-time protection settings can be tweaked to add files, folders, and memory areas to controlled folder access to prevent unauthorized changes.
- We can also add files or folders to an exclusion list, so they are not scanned. 
- An example would be excluding a folder of tools used for penetration testing from scanning as they will be flagged malicious and quarantined or removed from the system. 
- Controlled folder access is Defender's built-in Ransomware protection.
- We can use the PowerShell cmdlet `Get-MpComputerStatus` to check which protection settings are enabled.
```powershell-session
PS C:\htb> Get-MpComputerStatus | findstr "True"
AMServiceEnabled                : True
AntispywareEnabled              : True
AntivirusEnabled                : True
BehaviorMonitorEnabled          : True
IoavProtectionEnabled           : True
IsTamperProtected               : True
NISEnabled                      : True
OnAccessProtectionEnabled       : True
RealTimeProtectionEnabled       : True
```
- While no antivirus solution is perfect, Windows Defender does very well in monthly detection rate tests compared to other solutions, even paid ones. 
- Also, since it comes preinstalled as part of the operating system, it does not introduce "bloat" to the system, such as other programs that add browser extensions and trackers. 
- Other products are known to slow down the system due to the way they hook into the operating system.
- Windows Defender is not without its flaws and should be part of a defense-in-depth strategy built around core principles of configuration and patch management, not treated as a silver bullet for protecting our systems. 
- Definitions are updated constantly, and new versions of Windows Defender are built-in to major operating releases such as Windows 10, version 1909, which is the most recent version at the time of writing.
- Windows Defender will pick up payloads from common open-source frameworks such as Metasploit or unaltered versions of tools such as Mimikatz.
![[meterp_caught_png.png]]
- Though it is becoming increasingly difficult, it is still possible to fully bypass Windows Defender protections enforced by the latest version with the most up-to-date definitions installed.



### Questions
- Find the SID of the bob.smith user.
	- S-1-5-21-2614195641-1726409526-3792725429-1003
- What 3rd party security application is disabled at startup for the current user? (The answer is case sensitive).
	- NordVPN