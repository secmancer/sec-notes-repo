### Services Basics
- When exploring a machine, the very first important item we need to deal with is to identify the OS and any services that may be running on the system.
- Services: applications that perform useful functions for other users/computers.
	- Specialized machines that run specific services may be called servers rather than workstations, since their main purpose is to "serve" users that consume that specific service.
- What we want to know is if these services are misconfigured or have vulnerabilities in them.
- If these are the case, then we can possibly use the service to perform unintended action that may advance our own objectives, like executing commands of our own choice.
- As we know at this point, IP addresses are given to machines connected to a network. Services use this IP address, but also take advantage of a specific, non-repeating port to identify them.
- Ports can range from 1 to 65,535. The number 0 is intended for TCP/IP networking, so therefore, is not able to be used. Attempting to bind to it just results in the service getting the next available port.
- While services can use any of them, some of them have become well-known for being defaults for various services.
- However, going through all of these ports manually can be tiresome. That's why we have tools to make this process much easier and more efficient.


### Nmap
- This is one of those tools that can be service scanning much easier.
- Doing the most basic scan is pretty simple, which scans the 1,000 most common ports by default.
- If we have a target at 10.129.42.253 for example, then we can simply type out the command listed below:
```
secmancer@htb[/htb]$ nmap 10.129.42.253

Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-25 16:07 EST
Nmap scan report for 10.129.42.253
Host is up (0.11s latency).
Not shown: 995 closed ports
PORT    STATE SERVICE
21/tcp  open  ftp
22/tcp  open  ssh
80/tcp  open  http
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds

Nmap done: 1 IP address (1 host up) scanned in 2.19 seconds
```
- From the results, we can see that ports 21, 22, 80, 139, and 445 are available.
- The `PORT` heading contains information about the ports found.
	- By default, a TCP scan is done unless we request for UDP scan to happen.
- The `STATE` heading gives out the state of those ports. In this case, they are all marked as open.
	- However, ports can also have different states, like being `filtered`, which essentially means that that port can only be accessed if the firewall allows us to.
- The `SERVICE` heading gives out the name of that service that is usually mapped to that specific port.
- The default scan doesn't tell us what is listening on that port, however. Therefore, it's possible it could be another service altogether unless we instruct Nmap to dig deep into it.
- To add more information to the scan, we can use parameters like  the `-sC` parameter to tell Nmap to use its scripts to attempt to reach this goal.
- Some parameters are more specific, like the `-sV` parameter, which tells Nmap to use it scripts that attempt to identify the services, application name, and version of them. This scan uses a database of over 1,000 service signatures to do this.
- `-p-` allows us to scan all possible 65,535 TCP ports rather than the most common ones.
```
secmancer@htb[/htb]$ nmap -sV -sC -p- 10.129.42.253

Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-25 16:18 EST
Nmap scan report for 10.129.42.253
Host is up (0.11s latency).
Not shown: 65530 closed ports
PORT    STATE SERVICE     VERSION
21/tcp  open  ftp         vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_drwxr-xr-x    2 ftp      ftp          4096 Feb 25 19:25 pub
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:10.10.14.2
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
22/tcp  open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
80/tcp  open  http        Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: PHP 7.4.3 - phpinfo()
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_nbstat: NetBIOS name: GS-SVCSCAN, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-02-25T21:21:51
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 233.68 seconds
```
- This returns a lot more information. We see that it took a lot longer to scan 65,535 ports than 1,000 ports. 
- However, since we are trying to collection more information, including parameters increase the duration of a scan since more checks are needed.
- The `-sV` option reports service versions and attempts to identify the operating system. For example, `OpenSSH 8.2p1 Ubuntu 4ubuntu0.1` points to Ubuntu Linux Focal Fossa 20.04 based on package version formatting and changelogs.
- Inferring OS versions through application versions is not always reliable since newer packages can be installed on older OS versions.
- The `-sC` option uses default scripts to gather detailed information, such as HTTP server headers, page titles, and PHP version from a `PHPInfo` file, which can indicate vulnerabilities.
- Specific scripts can be run for targeted assessments, such as auditing for Citrix NetScaler vulnerabilities like CVE-2019-19781 using a custom `Nmap` script.
- Therefore, Nmap includes scripts for specific situations like this, as shown below.
```
secmancer@htb[/htb]$ locate scripts/citrix

/usr/share/nmap/scripts/citrix-brute-xml.nse
/usr/share/nmap/scripts/citrix-enum-apps-xml.nse
/usr/share/nmap/scripts/citrix-enum-apps.nse
/usr/share/nmap/scripts/citrix-enum-servers-xml.nse
/usr/share/nmap/scripts/citrix-enum-servers.nse
```
- To run a script, we can use the syntax: `nmap --script <script name> -p<port> <host>`.
- Overall, the scripts provided by Nmap gives us great functionality and information to our scans that make our lives easier during the enumeration stage.


### Banner Grabbing
- Banner grabbing is also a great way to identify a service.
- Nmap has scripts to grab the banners of these services, which we can do by using the following syntax: `nmap -sV --script=banner <target>`
- Netcat can also be used to do this manually, with an example of that below:
```shell-session
secmancer@htb[/htb]$ nc -nv 10.129.42.253 21

(UNKNOWN) [10.129.42.253] 21 (ftp) open
220 (vsFTPd 3.0.3)
```
- From the results, we can see the version of `vsFTPd` on the server is `3.0.3`.
- Automation of this process can also be done. 
	- An example of this is: `nmap -sV --script=banner -p21 10.10.10.0/24`


### FTP
- FTP can be a treasure trove of good data.
- A scan of using the default FTP port of 21 reveals to us the same vsftpd 3.0.3 installation we found earlier.
- We can also see that anonymous authentication is enabled and able to be used, along with a pub directory being available.
```
secmancer@htb[/htb]$ nmap -sC -sV -p21 10.129.42.253

Starting Nmap 7.80 ( https://nmap.org ) at 2020-12-20 00:54 GMT
Nmap scan report for 10.129.42.253
Host is up (0.081s latency).

PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_drwxr-xr-x    2 ftp      ftp          4096 Dec 19 23:50 pub
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:10.10.14.2
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 3
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
Service Info: OS: Unix

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 1.78 seconds
```
- Let's connect to the FTP service.
```shell-session
secmancer@htb[/htb]$ ftp -p 10.129.42.253

Connected to 10.129.42.253.
220 (vsFTPd 3.0.3)
Name (10.129.42.253:user): anonymous
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.

ftp> ls
227 Entering Passive Mode (10,129,42,253,158,60).
150 Here comes the directory listing.
drwxr-xr-x    2 ftp      ftp          4096 Feb 25 19:25 pub
226 Directory send OK.

ftp> cd pub
250 Directory successfully changed.

ftp> ls
227 Entering Passive Mode (10,129,42,253,182,129).
150 Here comes the directory listing.
-rw-r--r--    1 ftp      ftp            18 Feb 25 19:25 login.txt
226 Directory send OK.

ftp> get login.txt
local: login.txt remote: login.txt
227 Entering Passive Mode (10,129,42,253,181,53).
150 Opening BINARY mode data connection for login.txt (18 bytes).
226 Transfer complete.
18 bytes received in 0.00 secs (165.8314 kB/s)

ftp> exit
221 Goodbye.
```
-  FTP supports common commands such as `cd` and `ls`.
	- We can also download files with FTP by using the `get` command. 
- The downloaded `login.txt` we have reveals credentials that could be used for further access.
```shell-session
secmancer@htb[/htb]$ cat login.txt 

admin:ftp@dmin123
```


### SMB
- SMB (Server Message Block): protocol on Windows machines allows for many possible vertical and lateral movement. 
	- Sensitive data, including credentials, may be on network file shares that can be accessed by SMB.
	- Some SMB versions may be vulnerable to RCE exploits such as [EternalBlue](https://www.avast.com/c-eternalblue). 
- We need to approach this carefully, so luckily for us, Nmap has scripts that we can use for SMB enumeration, like [smb-os-discovery.nse](https://nmap.org/nsedoc/scripts/smb-os-discovery.html), which gets the OS version reported by the SMB service.
```shell-session
secmancer@htb[/htb]$ nmap --script smb-os-discovery.nse -p445 10.10.10.40

Starting Nmap 7.91 ( https://nmap.org ) at 2020-12-27 00:59 GMT
Nmap scan report for doctors.htb (10.10.10.40)
Host is up (0.022s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb-os-discovery: 
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: CEO-PC
|   NetBIOS computer name: CEO-PC\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2020-12-27T00:59:46+00:00

Nmap done: 1 IP address (1 host up) scanned in 2.71 seconds
```
- For the example above, we have a legacy Windows 7 system. So, with some further digging, we may have a system vulnerable to EternalBlue on our hands.
- Once again, lucky for us, Metasploit has several modules for EternalBlue that allows us to validate and then exploit the vulnerability.
- We can run futher scans to get more information from our system.
	- We can see that the host runs a Linux kernel, Samba version 4.6.2, and the hostname is GS-SVCSCAN.
- SMB allows users/administrators to share and make folders that are accessible remotely to others.
- Often, these have files in them that may have sensitive information in them.
- To get this possible information, we can use a tool to enumerate/interact with these SMB shares like [smbclient](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html). 
	-  `-L`: retrieve a list of available shares on the remote host
	- `-N`: suppresses the password prompt
```
secmancer@htb[/htb]$ smbclient -N -L \\\\10.129.42.253

	Sharename       Type      Comment
	---------       ----      -------
	print$          Disk      Printer Drivers
	users           Disk      
	IPC$            IPC       IPC Service (gs-svcscan server (Samba, Ubuntu))
SMB1 disabled -- no workgroup available
```
- We get the non-default share `users`. Maybe we can get a connection going as a guest?
```
secmancer@htb[/htb]$ smbclient \\\\10.129.42.253\\users

Enter WORKGROUP\users's password: 
Try "help" to get a list of possible commands.

smb: \> ls
NT_STATUS_ACCESS_DENIED listing \*

smb: \> exit
```
- Nope, never mind. Guest access is not allowed. 
- Let's try again by using the user bob (`bob:Welcome1`) and its corresponding credentials.
```
secmancer@htb[/htb]$ smbclient -U bob \\\\10.129.42.253\\users

Enter WORKGROUP\bob's password: 
Try "help" to get a list of possible commands.

smb: \> ls
  .                                   D        0  Thu Feb 25 16:42:23 2021
  ..                                  D        0  Thu Feb 25 15:05:31 2021
  bob                                 D        0  Thu Feb 25 16:42:23 2021

		4062912 blocks of size 1024. 1332480 blocks available
		
smb: \> cd bob

smb: \bob\> ls
  .                                   D        0  Thu Feb 25 16:42:23 2021
  ..                                  D        0  Thu Feb 25 16:42:23 2021
  passwords.txt                       N      156  Thu Feb 25 16:42:23 2021

		4062912 blocks of size 1024. 1332480 blocks available
		
smb: \bob\> get passwords.txt 
getting file \bob\passwords.txt of size 156 as passwords.txt (0.3 KiloBytes/sec) (average 0.3 KiloBytes/sec)
```
- We have now been able to get access into the share, and see that we have access to the `passwords.txt` file.
- We can download it to examine it using the get command.


### SNMP
- SNMP versions 1 and 2c use plaintext community strings like `public` and `private` for access control, which are often left at default settings.
- SNMPv3 introduces encryption and authentication for enhanced security.
- SNMP can reveal sensitive details such as process parameters (potentially exposing credentials), routing information, services on additional interfaces, and installed software versions.
- Exposed credentials from SNMP might be reused across other services due to common password reuse in enterprise environments.
```
secmancer@htb[/htb]$ snmpwalk -v 2c -c public 10.129.42.253 1.3.6.1.2.1.1.5.0

iso.3.6.1.2.1.1.5.0 = STRING: "gs-svcscan"
```
```
secmancer@htb[/htb]$ snmpwalk -v 2c -c private  10.129.42.253 

Timeout: No Response from 10.129.42.253
```
- Tools like [onesixtyone](https://github.com/trailofbits/onesixtyone) can be used to brute force these names by using common community strings, like the `dict.txt` file included from the tool's GitHub repo
```
secmancer@htb[/htb]$ onesixtyone -c dict.txt 10.129.42.254

Scanning 1 hosts, 51 communities
10.129.42.254 [public] Linux gs-svcscan 5.4.0-66-generic #74-Ubuntu SMP Wed Jan 27 22:54:38 UTC 2021 x86_64
```


### Questions
- Perform an Nmap scan of the target. What does Nmap display as the version of the service running on port 8080?
	- Apache Tomcat
- Perform an Nmap scan of the target and identify the non-default port that the telnet service is running on.
	- 2323
- List the SMB shares available on the target host. Connect to the available share as the bob user. Once connected, access the folder called 'flag' and submit the contents of the flag.txt file.
	- dceece590f3284c3866305eb2473d099