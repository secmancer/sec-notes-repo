### Introduction
- Linux is the most widely used OS for penetration testing and must be well-known.
- Establishing a standard setup ensures consistent configurations for penetration testing.
- If not prepared beforehand, set up a system immediately to save valuable time during tests.
- Prior to setup, review available penetration testing distributions.


### Penetration Testing Distributions
- There are many Linux distributions for penetration testing, each with its own advantages and disadvantages.
- Choosing the best distribution depends on personal needs and preferences.
- Tools for penetration testing can generally be installed on any distribution.
- Focus should be on what to expect from the distribution, such as community support and documentation.
- Popular penetration testing distributions include **ParrotOS**, Kali Linux, BlackArch, and BackBox.
- For this discussion, **ParrotOS Security** will be our chosen distribution.


### VM Setup
- Before installing ParrotOS Security, create a VM (using VMware Workstation in this example) and specify the installation `.iso` file.
- If VMware doesn't recognize the operating system, specify that ParrotOS is based on **Debian**.
- Assign a **name** to the VM and set the **path** where it will be stored.
- Set the **maximum size** of the VM, preferably larger than 20 GB to accommodate future packages and applications.
- Save the VM as a **single file** to simplify future transfers and management.


### ParrotOS Installation
- After creating the VM, start it and access the GRUB menu to select **ParrotOS installation**.
- Clicking on the VM window will trap the mouse, preventing it from leaving the window.
- To regain mouse control, press **[CTRL] + [ALT]** (most cases).
- Verify the key combination under `Edit > Preferences > Hot Keys` in VMware Workstation.

> Note: We can design all the steps according to our needs. However, we should stick to the given selection for uniformity in the steps shown to get the same result.

- During installation, select settings for language, location, keyboard, and partitioning.
- To encrypt data, select the **"Encrypt system"** option. Create a **Swap (no Hibernate)** partition if needed.
- Use **LVM** (Logical Volume Manager) for partitioning, providing flexibility and dynamic partitioning across multiple disks.
- LVM allows abstraction between disks, partitions, and file systems.
- After configuring LVM, specify the **username**, **hostname**, and **password**.
- Confirm all entries to complete the configuration and start using LVM.


### LUKS Encryption
- LVM adds an abstraction layer between physical storage and the operating system, organizing logical volumes and file systems.
- LVM can support RAID arrays to protect against individual hard disk failures, though it does not provide redundancy like RAID.
- The concept of LVM exists in Unix/Linux distributions as well as in other operating systems, like **Windows Storage Spaces** and **macOS CoreStorage**.
- During the partition disk step, an **encryption passphrase** will be required.
- The passphrase must be **strong** and securely stored (e.g., using a password manager).
- Re-enter the passphrase to confirm accuracy.
- #### LVM Passphrase
	- After selecting and confirming the passphrase, we’ll see an overview of all the created and configured partitions.
	- If no further configurations are needed, we can finish partitioning and apply the changes.
	- The operating system installation will proceed, and the VM will restart.
	- After the restart, a window will prompt for the passphrase to unlock the system.
- #### LVM Unlock Partition
	- If we have entered the passphrase correctly, then the operating system will boot up completely, and we will be able to log in. 
	- Here we enter the password for the username we have created.


### Updates & APT Package Manager
- After installation, update the operating system using the `APT` package management tool.
- **APT (Advanced Packaging Tool)** is used for package management, originating from Debian, and works with `dpkg`.
- APT allows searching, updating, and installing program packages.
- Repositories (package sources) are configured in `/etc/apt/sources.list` (for ParrotOS, located at `/etc/apt/sources.list.d/parrot.list`).


### ParrotOS Sources List
```shell-session
┌─[cry0l1t3@parrot]─[~]
└──╼ $ cat /etc/apt/sources.list.d/parrot.list

# parrot repository
# this file was automatically generated by parrot-mirror-selector
deb https://deb.parrot.sh/parrot/ rolling main contrib non-free
#deb-src https://deb.parrot.sh/parrot/ rolling main contrib non-free
deb https://deb.parrot.sh/parrot/ rolling-security main contrib non-free
#deb-src https://deb.parrot.sh/parrot/ rolling-security main contrib non-free
```
- The package manager accesses HTTP and FTP servers to obtain and install packages from repositories.
- APT automatically loads packages from the available repositories.
- Version comparisons are quick, allowing APT to load and update packages seamlessly from repositories.

### Updating ParrotOS
```shell-session
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ sudo apt update -y && sudo apt full-upgrade -y && sudo apt autoremove -y && sudo apt autoclean -y
[sudo] password for cry0l1t3:                                                 

Hit:1 https://deb.parrot.sh/parrot rolling InRelease
Hit:2 https://deb.parrot.sh/parrot rolling-security InRelease
Reading package lists... Done
Building dependency tree
Reading state information... Done
2310 packages can be upgraded. Run 'apt list --upgradable' to see them.       
Reading package lists... Done
Building dependency tree       
Reading state information... Done
Calculating upgrade... Done
The following packages were automatically installed and are no longer required:
  cryptsetup-nuke-password dwarfdump
  ...SNIP...
```


### Tools List
```shell-session
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ cat tools.list

netcat
ncat
nmap
wireshark
tcpdump
hashcat
ffuf
gobuster
hydra
zaproxy
proxychains
sqlmap
radare2
metasploit-framework
python2.7
python3
spiderfoot
theharvester
remmina
xfreerdp
rdesktop
crackmapexec
exiftool
curl
seclists
testssl.sh
git
vim
tmux
```
- If there are only a few packages that we want to install, we can enter them manually in the following command.


### Installing Additional Tools
```shell-session
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ sudo apt install netcat ncat nmap wireshark tcpdump ...SNIP... git vim tmux -y
[sudo] password for cry0l1t3:       

Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages were automatically installed and are no longer required: 
  libarmadillo9 libboost-locale1.71.0 libcfitsio8 libdap25 libgdal27 libgfapi0
  ...SNIP...
```
- However, if the list contains more than just five packages, we should always create a list and keep it updated. 
- With the following command, we will install all the tools from the list at once using APT.


### Installing Additional Tools from a List
```shell-session
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ sudo apt install $(cat tools.list | tr "\n" " ") -y
[sudo] password for cry0l1t3:       

Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages were automatically installed and are no longer required: 
  libarmadillo9 libboost-locale1.71.0 libcfitsio8 libdap25 libgdal27 libgfapi0
  ...SNIP...
```



### Using GitHub
- Some tools, such as those for Privilege Escalation, may not be available in repositories and need to be downloaded manually from platforms like GitHub.
- For example, to download the **Privilege-Escalation-Awesome-Scripts-Suite** from GitHub.
- #### Clone GitHub Repository
```shell-session
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ git clone https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite.git

Cloning into 'privilege-escalation-awesome-scripts-suite'...
remote: Enumerating objects: 29, done.
remote: Counting objects: 100% (29/29), done.
remote: Compressing objects: 100% (17/17), done.
remote: Total 5242 (delta 18), reused 22 (delta 11), pack-reused 5213
Receiving objects: 100% (5242/5242), 18.65 MiB | 5.11 MiB/s, done.
Resolving deltas: 100% (3129/3129), done.
```
- #### List Contents
```shell-session
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ ls -l privilege-escalation-awesome-scripts-suite/

total 16
-rwxrwxr-x 1 cry0l1t3 cry0l1t3 1069 Mar 23 16:41 LICENSE
drwxrwxr-x 3 cry0l1t3 cry0l1t3 4096 Mar 23 16:41 linPEAS
-rwxrwxr-x 1 cry0l1t3 cry0l1t3 2506 Mar 23 16:41 README.md
drwxrwxr-x 4 cry0l1t3 cry0l1t3 4096 Mar 23 16:41 winPEAS
```


### Snapshot
- After installing packages and repositories, take a **VM snapshot** labeled **"Initial Setup"**.
- Shutting down the OS before creating the snapshot reduces the time and ensures a consistent state.
- A snapshot allows reverting to a working version if configuration steps break the system.
- Take a powered-off snapshot after major configuration stages to preserve a known working state.
- Periodically taking snapshots during a penetration test is recommended to avoid data loss.


### Terminal Adjustment
- Different terminal emulators like **Terminator, GUake, iTerm2, Terminology** are popular depending on personal preferences.
- An efficient alternative to terminal emulators is **Tmux**.
- **Tmux** is a terminal multiplexer that allows creating multiple windows and sessions within a single terminal window.
- Tmux keeps processes alive even if the terminal session or SSH connection is closed.
- Ippsec has a video on **Tmux** where he explains its advantages and usage.
- #### Ippsec - Tmux
	- The **Bash Prompt Generator** ([bash-prompt-generator.org](https://bash-prompt-generator.org/)) helps customize the Bash prompt to suit personal preferences.
	- For penetration tests, displaying **timestamps** in the Bash prompt is crucial for tracking command execution timing.
	- Customize the Bash prompt to include timestamps using the Bash Prompt Generator.
- #### Customize Bash Prompt
```shell-session
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ cp .bashrc .bashrc.bak
┌─[cry0l1t3@parrotos]─[~]
└──╼ $ echo 'export PS1="-[\[$(tput sgr0)\]\[\033[38;5;10m\]\d\[$(tput sgr0)\]-\[$(tput sgr0)\]\[\033[38;5;10m\]\t\[$(tput sgr0)\]]-[\[$(tput sgr0)\]\[\033[38;5;214m\]\u\[$(tput sgr0)\]@\[$(tput sgr0)\]\[\033[38;5;196m\]\h\[$(tput sgr0)\]]-\n-[\[$(tput sgr0)\]\[\033[38;5;33m\]\w\[$(tput sgr0)\]]\\$ \[$(tput sgr0)\]"' >> .bashrc
```
- #### Customized Bash Prompt
```shell-session
-[Tue Mar 23-00:39:51]-[cry0l1t3@parrotos]-
-[~]$ 
```
- Adding a **minus (-)** at the beginning of commands helps filter logs to display only date, time, and specific commands.
- There are countless ways to customize the look and feel of a Linux distro.
- The **r/unixporn** community on Reddit showcases various GUI designs and customizations.


### Automation
- Automation is crucial, especially for internal penetration tests with internet access to adapt systems quickly and efficiently.
- Create **Bash scripts** to automate settings adjustments for new systems, such as configuring the Bash prompt.
- Example script for setting up the Bash prompt may include commands previously configured.
- #### Bash Prompt Customization Script - Prompt.sh
```bash
#!/bin/bash

#### Make a backup of the .bashrc file
cp ~/.bashrc ~/.bashrc.bak

#### Customize bash prompt
echo 'export PS1="-[\[$(tput sgr0)\]\[\033[38;5;10m\]\d\[$(tput sgr0)\]-\[$(tput sgr0)\]\[\033[38;5;10m\]\t\[$(tput sgr0)\]]-[\[$(tput sgr0)\]\[\033[38;5;214m\]\u\[$(tput sgr0)\]@\[$(tput sgr0)\]\[\033[38;5;196m\]\h\[$(tput sgr0)\]]-\n-[\[$(tput sgr0)\]\[\033[38;5;33m\]\w\[$(tput sgr0)\]]\\$ \[$(tput sgr0)\]"' >> ~/.bashrc
```
- If we then host this script on our VPS, we can retrieve it from our customer's Linux workstation and apply it.
- #### Request Prompt.sh
```shell-session
user@workstation:~$ curl -s http://myvps.vps-provider.net/Prompt.sh | bash
```
- #### Customized Bash Prompt
```shell-session
-[Wed Mar 24-11:27:15]-[user@workstation]-
-[~]$ 
```
- Naming automation scripts clearly helps in managing and understanding their purpose.
- If multiple scripts are created, a master script can execute all configurations from memory.
- Hosting these scripts on a **Virtual Private Server (VPS)** ensures easy access and sharing.
- Example scripts may include configurations for Bash prompts, system settings, and other tools.
- #### Customization Scripts
```shell-session
user@workstation:~$ cat customization-scripts.txt

Prompt.sh
Tools.sh
GUI.sh
Tmux.sh
Vim.sh
```
- Now we could write a Bash script that takes care of all these settings for us or even combines them into a single command.
- #### Customization Scripts Execution
```shell-session
user@workstation:~$ for script in $(cat customization-scripts.txt); do curl -s http://myvps.vps-provider.net/$script | bash; done
```
- With this command, each customization script is retrieved and executed one by one from our VPS. 
- This allows us to make any changes to the workstation or our new VM quickly from memory.


### Final Snapshot
- Once configurations and settings are adjusted, create a **Final snapshot** to save all changes.
- Add a description to the snapshot detailing the configurations and tasks completed.
- Test installation scripts by copying them to the host system, reverting the VM to the **Initial Setup** snapshot, and running the scripts.
- Once satisfied, switch back to the **Final snapshot** and proceed with VM encryption.


### VM Encryption
- Encrypting the VM with a strong password provides an additional layer of protection, ensuring the VM cannot be started without the password.
- Shut down and power off the VM, then go to **Edit virtual machine settings > Options tab**.
- Use **Access Control** settings to encrypt the VM, preventing cloning without decryption.
- More details are available in the [VMware documentation](https://docs.vmware.com/en/VMware-Workstation-Pro/16.0/com.vmware.ws.using.doc/GUID-8A64D0EF-CB0E-4C50-A034-3FD5C0A0F905.html).
- Upon reopening VMware, enter the encryption password to access and boot the VM.