**Security** is crucial in Windows operating systems due to their extensive attack surface. Windows systems, with their many built-in applications, features, and settings, are prone to misconfigurations that can expose them to attacks even if they are fully patched.

#### Key Points:
- **Attack Surface**: Windows systems have many components and configurations that can be exploited if not properly managed.
- **Vulnerabilities**: Windows has been subject to various critical vulnerabilities, resulting in effective remote and local exploits.
- **Security Improvements**: Microsoft continuously enhances Windows security features to counter sophisticated threats and support system hardening and intrusion detection.

#### Security Principles
Windows follows specific security principles involving units like:
- **Users**
- **Computers on the network**
- **Threads**
- **Processes**

These principles aim to make unauthorized access and exploitation more challenging.

#### Security Identifiers (SID)
Each security principal (user, group, etc.) has a unique **Security Identifier (SID)**. SIDs are used to distinguish between different principals and their rights, even if they have identical names.
- **Generation**: SIDs are automatically generated by the system.
- **Storage**: SIDs are stored in the security database and included in a user's access token.

#### Structure of SID
A SID is composed of:
- **Identifier Authority**: Indicates the authority (computer or network) that created the SID.
- **Relative ID (RID)**: Differentiates between individual accounts or groups.

**SID Pattern**:
```
(SID)-(revision level)-(identifier-authority)-(subauthority1)-(subauthority2)-(etc)
```

![[Screenshot_20240912_155013.png]]

**Breakdown**:
- **S**: Identifies the string as a SID.
- **1**: Revision Level (currently always 1).
- **5**: Identifier Authority (48-bit string identifying the SID creator).
- **21**: Subauthority1 (indicates the user's relation or group within the authority).
- **674899381-4069889467-2080702030**: Subauthority2 (identifies the specific computer or domain).
- **1002**: Subauthority3 (RID, which distinguishes individual accounts or groups).

#### Example Command
To display the SID of a user, use:
```
PS C:\htb> whoami /user
```
**Output Example**:
```
USER INFORMATION
----------------
User Name           SID
=================== =============================================
ws01\bob S-1-5-21-674899381-4069889467-2080702030-1002
```

#### Security Accounts Manager (SAM)
- **Purpose**: SAM grants rights and permissions to network resources, allowing specific processes to execute based on these rights.
- **Role**: It manages user accounts and their associated permissions on a Windows system.

#### Access Control Entries (ACE)
- **Definition**: ACEs define permissions and access rights for users, groups, or processes to securable objects such as files and processes.
- **Management**: ACEs are part of Access Control Lists (ACLs), which specify access controls for securable objects.

#### Access Control Lists (ACL)
- **Types**:
    - **Discretionary Access Control List (DACL)**: Specifies the permissions granted to users and groups.
    - **System Access Control List (SACL)**: Specifies the auditing settings for a securable object.

#### Security Descriptor
- **Function**: Contains the ACLs (DACL and SACL) and other security information that defines access permissions for securable objects.
- **Components**: Includes information about who has access to the object and what actions they can perform.

#### Access Tokens
- **Role**: Used during the authorization process to validate user permissions.
- **Contents**:
    - **SID**: Security Identifier that identifies the user or group.
    - **Other Security Information**: Includes details such as user rights and group memberships.

#### Authorization Process
1. **Initiation**: Each thread and process initiated by a user goes through an authorization process.
2. **Validation**: The Local Security Authority (LSA) validates the access tokens to ensure that the user has the necessary permissions.

### User Account Control (UAC)
#### Overview
- **Purpose**: UAC is a security feature in Windows designed to prevent unauthorized changes to the system and to mitigate malware from running or manipulating processes.
- **Admin Approval Mode**: Specifically aims to prevent unwanted software installation and system-wide changes without administrator approval.

#### How UAC Works
- **Consent Prompt**: When an action requires administrative rights (e.g., installing software), UAC displays a consent prompt asking for confirmation.
- **Standard Users**: Cannot perform administrative actions without the administrator password or consent. If a standard user tries to execute a script or binary requiring admin rights, the execution will be denied or prompted for an administrator password.
- **Administrator Accounts**: Even admins must provide consent for actions that require elevated privileges. This ensures that even if an admin account is compromised, the attacker cannot perform high-risk actions without user consent.

#### UAC Structure
- **Triggers**: The consent prompt is triggered by actions that require higher privileges, such as:
    - Installing new software
    - Changing system settings
    - Running executables that request elevated permissions

#### Diagram
- **Illustration**: A visual representation of how UAC functions is often used to show the flow from a user action to the consent prompt and the elevation process. This diagram typically includes:
    - User Action
    - UAC Prompt
    - Consent/Password Entry
    - Elevated Execution

#### Key Points
- **Interrupts Execution**: UAC interrupts the execution of scripts or binaries that require elevated privileges until the appropriate credentials or consent are provided.
- **Security**: Enhances security by ensuring that users are aware of and approve significant changes or installations.

![[uacarchitecture1.png]]

### Registry in Windows
#### Overview
- **Function**: The Registry is a hierarchical database used by Windows to store configuration settings for the operating system and applications.
- **Access**: The Registry Editor can be accessed by typing `regedit` into the command line or Windows search bar.

#### Structure
- **Tree-Structure**: Consists of root keys, subkeys, and values.
    - **Root Keys**: Major branches in the Registry.
    - **Subkeys**: Folders within root keys.
    - **Values**: Entries or files within subkeys.

#### Value Types
- **REG_BINARY**: Binary data.
- **REG_DWORD**: 32-bit number.
- **REG_DWORD_LITTLE_ENDIAN**: 32-bit number in little-endian format.
- **REG_DWORD_BIG_ENDIAN**: 32-bit number in big-endian format.
- **REG_EXPAND_SZ**: String with environment variable references.
- **REG_LINK**: Unicode string for symbolic link targets.
- **REG_MULTI_SZ**: Sequence of null-terminated strings.
- **REG_NONE**: No defined value type.
- **REG_QWORD**: 64-bit number.
- **REG_QWORD_LITTLE_ENDIAN**: 64-bit number in little-endian format.
- **REG_SZ**: Null-terminated string.

#### Root Keys
- **HKEY_LOCAL_MACHINE (HKLM)**: Contains system-wide settings, including:
    - **SAM**: Security Accounts Manager
    - **SECURITY**: Security settings
    - **SYSTEM**: System configuration
    - **SOFTWARE**: Installed software
    - **HARDWARE**: Hardware configuration (dynamically loaded)
    - **BCD**: Boot Configuration Data
- **HKEY_USERS (HKU)**: User-specific settings for all users.
- **HKEY_CURRENT_USER (HKCU)**: User-specific settings for the currently logged-in user.
- **HKEY_CLASSES_ROOT (HKCR)**: File associations and COM class registrations.
- **HKEY_CURRENT_CONFIG (HKCC)**: Current hardware profile.

![[Screenshot_20240912_154951.png]]
#### File Locations
- **System Registry Files**: Stored under `C:\Windows\System32\Config\`
    - **Examples**:
        - `SYSTEM`
        - `SOFTWARE`
        - `SAM`
        - `SECURITY`
- **User-Specific Registry Hive**: Stored in the user folder as `Ntuser.dat`, e.g., `C:\Users\<USERNAME>\Ntuser.dat`.

#### Examples of File Listings
- **System Registry Files**:
```
Directory: C:\Windows\system32\config

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         8/13/2020   6:02 PM       33816576 COMPONENTS
-a----         8/13/2020   6:02 PM         524288 DEFAULT
-a----         8/13/2020   6:02 PM       87818240 SOFTWARE
-a----         8/13/2020   6:02 PM       17039360 SYSTEM
```
- **User-Specific Registry File**:
```
Directory: C:\Users\bob

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a-h--         8/13/2020   6:01 PM        2883584 NTUSER.DAT
```

### Registry Overview
- **Registry**: A hierarchical database in Windows that stores low-level settings for the OS and applications.
- **Access**: Open Registry Editor by typing `regedit` in the command line or Windows search bar.

#### Registry Structure
- **Root Keys**: Main folders at the top of the tree.
- **Subkeys**: Folders within root keys.
- **Values**: Entries/files in subkeys.

#### Value Types
- **REG_BINARY**: Binary data.
- **REG_DWORD**: 32-bit number.
- **REG_DWORD_LITTLE_ENDIAN**: 32-bit number in little-endian format.
- **REG_DWORD_BIG_ENDIAN**: 32-bit number in big-endian format.
- **REG_EXPAND_SZ**: String with environment variable references.
- **REG_LINK**: Unicode string for symbolic links.
- **REG_MULTI_SZ**: Sequence of null-terminated strings.
- **REG_NONE**: No defined value type.
- **REG_QWORD**: 64-bit number.
- **REG_QWORD_LITTLE_ENDIAN**: 64-bit number in little-endian format.
- **REG_SZ**: Null-terminated string.

#### Key Locations
- **System Registry Files**: Stored under `C:\Windows\System32\Config\`.
- **User-Specific Registry Hive**: Stored in `C:\Users\<USERNAME>\Ntuser.dat`.

### Run and RunOnce Registry Keys
- **HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run**
- **HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run**
- **HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce**
- **HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce**

#### Examples
- **HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run**:
    - `SecurityHealth` - `%windir%\system32\SecurityHealthSystray.exe`
    - `RTHDVCPL` - `"C:\Program Files\Realtek\Audio\HDA\RtkNGUI64.exe" -s`
    - `Greenshot` - `C:\Program Files\Greenshot\Greenshot.exe`
- **HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run**:
    - `OneDrive` - `"C:\Users\bob\AppData\Local\Microsoft\OneDrive\OneDrive.exe" /background`
    - `OPENVPN-GUI` - `C:\Program Files\OpenVPN\bin\openvpn-gui.exe`
    - `Docker Desktop` - `C:\Program Files\Docker\Docker\Docker Desktop.exe`

### Application Whitelisting
- **Purpose**: Protects systems by allowing only approved software.
- **Approach**: "Zero trust" principle; only approved applications are allowed.
- **Whitelisting vs. Blacklisting**:
    - **Whitelisting**: Only specified applications are allowed.
    - **Blacklisting**: Specifies applications to block; all others are allowed.
- **Recommendation**: Implement in audit mode initially to prevent blocking necessary applications.

### AppLocker
- **Introduction**: Microsoft's application whitelisting tool introduced in Windows 7.
- **Functionality**:
    - Controls which applications and files can be run.
    - Rules based on file attributes, paths, and hashes.
    - Can be applied to security groups or individual users.
    - Supports audit mode to test impact before enforcing rules.

### Local Group Policy
- **Purpose**: Configures and adjusts various settings on individual machines or domain environments.
- **Access**: Open Local Group Policy Editor via `gpedit.msc`.
- **Categories**:
    - **Computer Configuration**: For system-wide settings.
    - **User Configuration**: For settings specific to users.
- **Examples**:
    - Enabling Credential Guard.
    - Configuring AppLocker and account auditing.

### Windows Defender Antivirus
- **Overview**: Built-in antivirus tool in Windows, formerly known as Windows Defender.
- **Features**:
    - **Real-time Protection**: Guards against known threats.
    - **Cloud-Delivered Protection**: Uploads suspicious files for analysis.
    - **Tamper Protection**: Prevents changes to security settings.
- **Management**: Configured from the Security Center.
- **PowerShell Cmdlet**: `Get-MpComputerStatus` to check protection settings.

#### Performance
- **Detection Rate**: Performs well in monthly detection rate tests compared to other solutions.
- **Integration**: Preinstalled and does not introduce additional bloat.

#### Limitations
- **Bypass**: It is still possible to bypass Windows Defender protections with advanced techniques.

## Questions
- Find the SID of the bob.smith user.
	- S-1-5-21-2614195641-1726409526-3792725429-1003
- What 3rd party security application is disabled at startup for the current user? (The answer is case sensitive).
	- NordVPN